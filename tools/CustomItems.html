<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>道具配置编辑器 (YAML 版)</title>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <style>
        body {
            font-family: "Microsoft YaHei", sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        button, input[type="file"] {
            padding: 8px 16px;
            font-size: 16px;
        }
        .entry {
            border: 1px solid #ccc;
            background: #fff;
            margin-bottom: 10px;
            border-radius: 6px;
            padding: 15px;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }
        .field-group {
            margin-bottom: 10px;
        }
        label {
            font-weight: bold;
            display: block;
            margin-bottom: 4px;
        }
        input, textarea, select {
            width: 100%;
            padding: 6px;
            font-size: 14px;
        }
    </style>
</head>
<body>

<h1>道具配置编辑器 (YAML)</h1>
<div class="controls">
    <input type="file" id="fileInput" accept=".yml,.yaml">
    <button onclick="addEntry()">新增道具</button>
    <button onclick="downloadYAML()">下载YAML</button>
</div>
<div id="editor"></div>

<script>
    let yamlData = {};
    const SENSITIVITY = 2.52;
    const YAW_PITCH_VALUE = 0.022;

    function renderEditor() {
        const container = document.getElementById('editor');
        container.innerHTML = '';

        Object.entries(yamlData).forEach(([id, entry]) => {
            const div = document.createElement('div');
            div.className = 'entry';

            const fields = [
                { label: "唯一标识符 ID", key: 'id', value: id, readonly: true },
                { label: "文件名", key: 'filename' },
                { label: "显示名称", key: 'displayname' },
                { label: "地图", key: 'map' },
                { label: "类型", key: 'type' },
                { label: "投掷方式", key: 'throwmode' },
                { label: "灵敏度", key: 'sensitivity' },
                { label: "Yaw", key: 'yaw' },
                { label: "Pitch", key: 'pitch' }
            ];

            fields.forEach(({ label, key, value, readonly }) => {
                const group = document.createElement('div');
                group.className = 'field-group';

                const lbl = document.createElement('label');
                lbl.textContent = label;

                const input = document.createElement('input');
                input.value = value ?? entry[key] ?? '';
                if (readonly) input.readOnly = true;
                input.addEventListener('input', e => {
                    if (key === 'id') return;
                    yamlData[id][key] = e.target.value;
                });

                group.appendChild(lbl);
                group.appendChild(input);
                div.appendChild(group);
            });

            // Extra
            ['pre', 'post'].forEach((type, i) => {
                const group = document.createElement('div');
                group.className = 'field-group';
                const lbl = document.createElement('label');
                lbl.textContent = type === 'pre' ? '投掷前命令 Extra[0]' : '投掷后命令 Extra[1]';
                const input = document.createElement('input');
                input.value = entry.extra?.[i] || '';
                input.addEventListener('input', e => {
                    yamlData[id].extra = yamlData[id].extra || ['', ''];
                    yamlData[id].extra[i] = e.target.value;
                });
                group.appendChild(lbl);
                group.appendChild(input);
                div.appendChild(group);
            });

            // Select
            ['page', 'slot', 'command', 'bind'].forEach((selKey, i) => {
                const group = document.createElement('div');
                group.className = 'field-group';
                const lbl = document.createElement('label');
                lbl.textContent = `轮盘设置 select.${selKey}`;
                const input = document.createElement('input');
                input.value = entry.select?.[i]?.[selKey] || '';
                input.addEventListener('input', e => {
                    yamlData[id].select = yamlData[id].select || [{}, {}, {}, {}];
                    yamlData[id].select[i][selKey] = e.target.value;
                });
                group.appendChild(lbl);
                group.appendChild(input);
                div.appendChild(group);
            });

            // Setpos
            ['x', 'z', 'y'].forEach((coord, i) => {
                const group = document.createElement('div');
                group.className = 'field-group';
                const lbl = document.createElement('label');
                lbl.textContent = `坐标 setpos.${coord}`;
                const input = document.createElement('input');
                input.type = 'number';
                input.value = entry.setpos?.[i]?.[coord] || 0;
                input.addEventListener('input', e => {
                    yamlData[id].setpos = yamlData[id].setpos || [{}, {}, {}];
                    yamlData[id].setpos[i][coord] = parseFloat(e.target.value);
                });
                group.appendChild(lbl);
                group.appendChild(input);
                div.appendChild(group);
            });

            container.appendChild(div);
        });
    }

    document.getElementById('fileInput').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
            try {
                yamlData = jsyaml.load(e.target.result) || {};
                renderEditor();
            } catch (err) {
                alert("解析失败：" + err.message);
            }
        };
        reader.readAsText(file);
    });

    function addEntry() {
        const id = `item_${Date.now()}`;
        yamlData[id] = {
            filename: `${id}.cfg`,
            displayname: "新道具",
            map: "Dust2",
            sensitivity: 2.52,
            yaw: 0,
            pitch: 0,
            type: "smoke",
            throwmode: "Normal",
            extra: ["", ""],
            select: [{ page: "" }, { slot: "" }, { command: "" }, { bind: "None" }],
            setpos: [{ x: 0 }, { z: 0 }, { y: 100 }]
        };
        renderEditor();
    }

    function downloadYAML() {
        const yamlStr = jsyaml.dump(yamlData, { skipInvalid: true, sortKeys: false });
        const blob = new Blob([yamlStr], { type: 'application/x-yaml' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Custom.yml';
        a.click();
        URL.revokeObjectURL(url);
    }
</script>

</body>
</html>
