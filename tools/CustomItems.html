<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>道具配置编辑器 (YAML 版)</title>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <style>
        body {
            font-family: "Microsoft YaHei", sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            align-items: flex-start;
        }
        button, input[type="file"], input[type="text"] {
            padding: 8px 16px;
            font-size: 16px;
        }
        .grenade-list {
            max-width: 1000px;
            margin: 0 auto;
        }
        .grenade-entry {
            border: 1px solid #ccc;
            background: #fff;
            margin-bottom: 10px;
            border-radius: 6px;
            overflow: hidden;
        }
        .grenade-header {
            padding: 10px 15px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        .grenade-body {
            display: none;
            padding: 15px;
            background: #f9f9f9;
        }
        .field-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        .field-group label {
            font-weight: bold;
            margin-bottom: 4px;
        }
        .field-group input, .field-group textarea {
            padding: 6px;
            font-size: 14px;
        }
        .inline-group {
            display: flex;
            gap: 10px;
        }
        .inline-group .field-group {
            flex: 1;
        }

        /* FOV计算器样式 */
        .fov-container {
            border: 1px solid #ccc;
            background: #fff;
            border-radius: 6px;
            padding: 15px;
            width: 320px;
            font-size: 14px;
            color: #333;
            user-select: none;
        }
        .fov-container label {
            font-weight: bold;
            margin-top: 10px;
            display: block;
        }
        .fov-container input[type="text"] {
            width: 100%;
            box-sizing: border-box;
            margin-top: 6px;
            margin-bottom: 6px;
            padding: 6px;
            font-size: 14px;
        }
        .output-box {
            background: #f0f0f0;
            border: 1px solid #bbb;
            border-radius: 4px;
            padding: 8px;
            margin-top: 4px;
            cursor: pointer;
            user-select: all;
        }
        .output-box:hover {
            background: #e0e0e0;
        }
    </style>
</head>
<body>

<h1>道具配置编辑器 (YAML)</h1>
<div class="controls">
    <input type="file" id="fileInput" accept=".yml,.yaml">
    <button onclick="addEntry()">新增道具</button>
    <button onclick="downloadYAML()">下载YAML</button>

    <!-- 新增 FOV 计算器区域 -->
    <div class="fov-container" title="点击输出框复制结果">
        <label for="fovInput">输入 X, A, B（用逗号或空格分隔）:</label>
        <input id="fovInput" type="text" placeholder="例如：180, 2.52, 1.2" />
        <label>计算后的 yaw:</label>
        <div id="yawOutput" class="output-box">-</div>
        <label>计算后的 pitch:</label>
        <div id="pitchOutput" class="output-box">-</div>
    </div>
</div>

<div id="editor" class="grenade-list"></div>

<script>
    let yamlData = {};

    function renderEditor() {
        const container = document.getElementById('editor');
        container.innerHTML = '';

        Object.entries(yamlData).forEach(([id, g]) => {
            const entry = document.createElement('div');
            entry.className = 'grenade-entry';

            const header = document.createElement('div');
            header.className = 'grenade-header';
            header.textContent = g.displayname || id;

            const body = document.createElement('div');
            body.className = 'grenade-body';

            header.onclick = () => {
                body.style.display = body.style.display === 'none' ? 'block' : 'none';
            };

            // ✅ 唯一标识符 ID 输入
            const idGroup = document.createElement('div');
            idGroup.className = 'field-group';
            const idLabel = document.createElement('label');
            idLabel.textContent = '唯一标识符 ID';
            const idInput = document.createElement('input');
            idInput.value = id;
            idInput.addEventListener('change', (e) => {
                const newId = e.target.value.trim();
                if (!newId || newId === id || yamlData[newId]) {
                    alert("ID 无效或已存在！");
                    idInput.value = id;
                    return;
                }
                yamlData[newId] = yamlData[id];
                delete yamlData[id];
                renderEditor();
            });
            idGroup.appendChild(idLabel);
            idGroup.appendChild(idInput);
            body.appendChild(idGroup);

            // 字段辅助函数
            function addField(labelText, key, object = g) {
                const group = document.createElement('div');
                group.className = 'field-group';
                const label = document.createElement('label');
                label.textContent = labelText;
                const input = document.createElement('input');
                input.value = object[key] ?? '';
                input.addEventListener('input', e => {
                    object[key] = e.target.value;
                });
                group.appendChild(label);
                group.appendChild(input);
                body.appendChild(group);
            }

            addField("显示名称", 'displayname');
            addField("文件名", 'filename');
            addField("地图", 'map');
            addField("类型", 'type');
            addField("投掷方式", 'throwmode');
            addField("灵敏度", 'sensitivity');

            const angleGroup = document.createElement('div');
            angleGroup.className = 'inline-group';
            ['yaw', 'pitch'].forEach((angle) => {
                const group = document.createElement('div');
                group.className = 'field-group';
                const label = document.createElement('label');
                label.textContent = `角度 ${angle}`;
                const input = document.createElement('input');
                input.type = 'number';
                input.value = g[angle] ?? 0;
                input.addEventListener('input', e => {
                    g[angle] = parseFloat(e.target.value);
                });
                group.appendChild(label);
                group.appendChild(input);
                angleGroup.appendChild(group);
            });
            body.appendChild(angleGroup);

            ['投掷前命令 (Extra[0])', '投掷后命令 (Extra[1])'].forEach((label, idx) => {
                const group = document.createElement('div');
                group.className = 'field-group';
                const lbl = document.createElement('label');
                lbl.textContent = label;
                const input = document.createElement('input');
                input.value = g.extra?.[idx] ?? '';
                input.addEventListener('input', e => {
                    g.extra = g.extra || ['', ''];
                    g.extra[idx] = e.target.value;
                });
                group.appendChild(lbl);
                group.appendChild(input);
                body.appendChild(group);
            });

            const selectFields = ['page', 'slot', 'command', 'bind'];
            selectFields.forEach((key, idx) => {
                const group = document.createElement('div');
                group.className = 'field-group';
                const lbl = document.createElement('label');
                lbl.textContent = `轮盘 ${key}`;
                const input = document.createElement('input');
                input.value = g.select?.[idx]?.[key] ?? '';
                input.addEventListener('input', e => {
                    g.select = g.select || [{}, {}, {}, {}];
                    g.select[idx][key] = e.target.value;
                });
                group.appendChild(lbl);
                group.appendChild(input);
                body.appendChild(group);
            });

            const posGroup = document.createElement('div');
            posGroup.className = 'inline-group';
            ['x', 'z', 'y'].forEach((coord, idx) => {
                const group = document.createElement('div');
                group.className = 'field-group';
                const label = document.createElement('label');
                label.textContent = `坐标 ${coord}`;
                const input = document.createElement('input');
                input.type = 'number';
                input.value = g.setpos?.[idx]?.[coord] ?? 0;
                input.addEventListener('input', e => {
                    g.setpos = g.setpos || [{}, {}, {}];
                    g.setpos[idx][coord] = parseFloat(e.target.value);
                });
                group.appendChild(label);
                group.appendChild(input);
                posGroup.appendChild(group);
            });
            body.appendChild(posGroup);

            entry.appendChild(header);
            entry.appendChild(body);
            container.appendChild(entry);
        });
    }

    document.getElementById('fileInput').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
            try {
                yamlData = jsyaml.load(e.target.result) || {};
                renderEditor();
            } catch (err) {
                alert("解析失败：" + err.message);
            }
        };
        reader.readAsText(file);
    });

    function addEntry() {
        const id = `item_${Date.now()}`;
        yamlData[id] = {
            filename: `${id}.cfg`,
            displayname: "新道具",
            map: "Dust2",
            sensitivity: 2.52,
            yaw: 0,
            pitch: 0,
            type: "smoke",
            throwmode: "Normal",
            extra: ["", ""],
            select: [{ page: "" }, { slot: "" }, { command: "" }, { bind: "None" }],
            setpos: [{ x: 0 }, { z: 0 }, { y: 100 }]
        };
        renderEditor();
    }

    function downloadYAML() {
        let yamlStr = jsyaml.dump(yamlData, {
            skipInvalid: true,
            sortKeys: false,
            flowLevel: 2
        });

        yamlStr = yamlStr.replace(/extra:\s*\n\s*- "?"?([^"\n]*)"?\n\s*- "?"?([^"\n]*)"?/g, (match, p1, p2) => {
            return `extra: ["${p1}", "${p2}"]`;
        });

        const blob = new Blob([yamlStr], { type: 'application/x-yaml' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Custom.yml';
        a.click();
        URL.revokeObjectURL(url);
    }

    // --- FOV 计算器逻辑 ---
    const fovInput = document.getElementById('fovInput');
    const yawOutput = document.getElementById('yawOutput');
    const pitchOutput = document.getElementById('pitchOutput');

    function roundSix(num) {
        return Math.round(num * 1e6) / 1e6;
    }

    function calculateFOV() {
        const val = fovInput.value.trim();
        if (!val) {
            yawOutput.textContent = '-';
            pitchOutput.textContent = '-';
            return;
        }

        // 支持逗号或空格分隔
        const parts = val.split(/[\s,]+/).map(s => parseFloat(s));
        if (parts.length !== 3 || parts.some(isNaN)) {
            yawOutput.textContent = '输入格式错误';
            pitchOutput.textContent = '输入格式错误';
            return;
        }

        const [X, A, B] = parts;
        if (A === 0 || B === 0) {
            yawOutput.textContent = 'A 或 B 不能为 0';
            pitchOutput.textContent = 'A 或 B 不能为 0';
            return;
        }

        const result = roundSix(X / (A * B));
        yawOutput.textContent = result;
        pitchOutput.textContent = result;
    }

    fovInput.addEventListener('input', calculateFOV);

    // 复制功能
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('复制成功: ' + text);
        }, () => {
            alert('复制失败，请手动复制');
        });
    }

    yawOutput.addEventListener('click', () => {
        if (yawOutput.textContent && yawOutput.textContent !== '-' && !yawOutput.textContent.includes('错误')) {
            copyToClipboard(yawOutput.textContent);
        }
    });
    pitchOutput.addEventListener('click', () => {
        if (pitchOutput.textContent && pitchOutput.textContent !== '-' && !pitchOutput.textContent.includes('错误')) {
            copyToClipboard(pitchOutput.textContent);
        }
    });

</script>

</body>
</html>
